# ランキング画面 フロントエンド設計書

## 概要

本ドキュメントは、パズルゲームアプリケーションのランキング画面機能をフロントエンドに実装するための詳細設計書です。バックエンドAPIは既に完全に実装されているため、フロントエンドのUI/UXとAPIとの統合に焦点を当てます。

## 現在の実装状況

### 🟢 完了済み
- **バックエンドAPI**: ランキング関連の全API実装済み
  - `GET /scores/ranking` - ランキング取得（フィルタリング、ページネーション対応）
  - `GET /scores/user/:userId` - ユーザースコア履歴取得
  - `POST /scores` - スコア登録（ランキング情報付きレスポンス）
- **データベース**: 完全実装済み
  - `scores` テーブル（score, stage, difficulty, user_id, created_at等）
  - 高性能なランキング取得クエリ
- **認証システム**: WebAuthn認証完全実装済み
- **基本ゲーム機能**: スコア計算・投稿機能完全実装済み

### 🟡 部分実装済み
- **スコア表示**: GameOverModalで個人順位表示のみ
- **ナビゲーション**: HamburgerMenuにランキング項目なし

### 🔴 未実装
1. **ランキング画面UI**: 全体ランキング表示コンポーネント
2. **ナビゲーション統合**: メニューからランキング画面への遷移
3. **フィルタリング機能**: 難易度・期間別ランキング
4. **ユーザースコア履歴**: 個人スコア詳細表示
5. **レスポンシブデザイン**: モバイル・デスクトップ対応

## 実装対象

### 1. ランキング表示機能
- 全体ランキング表示
- ユーザー個人ランキング表示
- フィルタリング機能（難易度・期間別）
- ページネーション機能

### 2. ナビゲーション統合
- ハンバーガーメニューへのランキング項目追加
- モーダル形式でのランキング画面表示

### 3. ユーザー体験向上
- ローディング状態表示
- エラーハンドリング
- 空状態表示
- レスポンシブデザイン

## 詳細実装仕様

### 1. コンポーネント構成

#### 1.1 メインコンポーネント
```
RankingModal (新規作成)
├── RankingHeader (フィルタリング・タブ切替)
├── RankingList (ランキング一覧表示)
├── UserRankingSection (個人ランキング表示)
├── PaginationControls (ページネーション)
└── LoadingSpinner (ローディング表示)
```

#### 1.2 既存コンポーネント修正
```
HamburgerMenu (修正)
└── ランキングメニュー項目追加

App.tsx (修正)
└── RankingModal状態管理追加
```

### 1.3 新規作成コンポーネント詳細

#### RankingModal.tsx
```typescript
interface RankingModalProps {
  isOpen: boolean;
  onClose: () => void;
}

interface RankingState {
  rankings: RankingEntry[];
  userRanking: UserRankingInfo | null;
  loading: boolean;
  error: string | null;
  filters: RankingFilters;
  pagination: PaginationInfo;
}

interface RankingFilters {
  difficulty: 'all' | 'easy' | 'medium' | 'hard';
  period: 'all' | 'daily' | 'weekly' | 'monthly';
}
```

#### RankingList.tsx
```typescript
interface RankingListProps {
  rankings: RankingEntry[];
  currentUserId?: string;
  loading: boolean;
}

interface RankingEntry {
  rank: number;
  username: string;
  score: number;
  stage: number;
  difficulty: string;
  created_at: string;
  isCurrentUser?: boolean;
}
```

### 2. UI/UX設計

#### 2.1 ランキングモーダル - メインビュー
```
┌─────────────────────────────────────────────────────────┐
│ ×                    ランキング                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ [全体] [個人記録]                    [難易度▼] [期間▼]  │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  順位  ユーザー名    スコア   ステージ  難易度  日時   │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │  🥇 1  PlayerOne    15,420    Stage12   Hard   今日  │ │
│ │  🥈 2  PlayerTwo    14,850    Stage11   Hard   昨日  │ │
│ │  🥉 3  PlayerThree  14,200    Stage10   Hard   2日前 │ │
│ │     4  PlayerFour   13,800    Stage10   Medium 3日前 │ │
│ │  → 5  あなた        13,500    Stage09   Medium 今日  │ │  
│ │     6  PlayerSix    13,200    Stage09   Easy   昨日  │ │
│ │     ...                                              │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│            [前のページ]  1/10  [次のページ]              │
└─────────────────────────────────────────────────────────┘
```

#### 2.2 ランキングモーダル - 個人記録ビュー
```
┌─────────────────────────────────────────────────────────┐
│ ×                    ランキング                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ [全体] [個人記録]                    [難易度▼] [期間▼]  │
│                                                         │
│ あなたの最高記録                                        │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 🏆 全体ランキング: 5位 / 1,234人                     │ │
│ │ 📊 最高スコア: 13,500 (Stage 9, Medium)              │ │
│ │ 🎯 今日のベスト: 12,800 (3位)                        │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 最近のスコア履歴                                        │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  スコア   ステージ  難易度  ランキング    日時        │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │  13,500   Stage09   Medium    5位      今日 14:30   │ │
│ │  12,800   Stage08   Medium    8位      今日 12:15   │ │
│ │  11,200   Stage07   Easy     15位      昨日 18:45   │ │
│ │  10,500   Stage06   Easy     22位      昨日 16:20   │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│            [前のページ]  1/3  [次のページ]               │
└─────────────────────────────────────────────────────────┘
```

#### 2.3 ハンバーガーメニュー（修正後）
```
┌─────────────────┐
│ ☰               │
├─────────────────┤
│ ◀ ゲームに戻る   │
│ 👤 プロフィール  │
│ 🏆 ランキング    │  ← 新規追加
│ ⚙️ 設定         │
│ 🚪 ログアウト    │
└─────────────────┘
```

#### 2.4 モバイル対応版
```
┌─────────────────────┐
│ ×      ランキング    │
├─────────────────────┤
│ [全体] [個人]       │
│ [難易度▼] [期間▼]   │
│                     │
│ ┌─────────────────┐ │
│ │ 🥇1 PlayerOne   │ │
│ │    15,420pt     │ │
│ │    Stage12/Hard │ │
│ ├─────────────────┤ │
│ │ 🥈2 PlayerTwo   │ │
│ │    14,850pt     │ │
│ │    Stage11/Hard │ │
│ ├─────────────────┤ │
│ │ →5 あなた       │ │
│ │    13,500pt     │ │
│ │    Stage09/Med  │ │
│ └─────────────────┘ │
│  [前へ] 1/10 [次へ] │
└─────────────────────┘
```

### 3. API統合設計

#### 3.1 API呼び出し関数
```typescript
// src/utils/ranking-api.ts
export interface RankingParams {
  limit?: number;
  offset?: number;
  difficulty?: 'easy' | 'medium' | 'hard';
  period?: 'daily' | 'weekly' | 'monthly' | 'all';
}

export interface RankingResponse {
  rankings: RankingEntry[];
  total: number;
  user_rank?: number;
}

export interface UserScoreHistoryResponse {
  scores: UserScoreEntry[];
  total: number;
  stats: UserStats;
}

export async function fetchRanking(params: RankingParams): Promise<RankingResponse>;
export async function fetchUserScoreHistory(userId: string, params: RankingParams): Promise<UserScoreHistoryResponse>;
```

#### 3.2 状態管理
```typescript
// src/hooks/useRanking.ts
export function useRanking() {
  const [rankings, setRankings] = useState<RankingEntry[]>([]);
  const [userRanking, setUserRanking] = useState<UserRankingInfo | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [filters, setFilters] = useState<RankingFilters>({
    difficulty: 'all',
    period: 'all'
  });
  const [pagination, setPagination] = useState<PaginationInfo>({
    currentPage: 1,
    totalPages: 1,
    totalItems: 0,
    itemsPerPage: 20
  });

  const fetchRankingData = useCallback(async () => { /* ... */ }, [filters, pagination]);
  const refreshRanking = useCallback(() => { /* ... */ }, []);

  return {
    rankings,
    userRanking,
    loading,
    error,
    filters,
    pagination,
    setFilters,
    setPagination,
    fetchRankingData,
    refreshRanking
  };
}
```

### 4. レスポンシブデザイン対応

#### 4.1 ブレークポイント
```css
/* Mobile: 320px - 767px */
/* Tablet: 768px - 1023px */
/* Desktop: 1024px+ */
```

#### 4.2 レイアウト調整
- **モバイル**: 単一カラム、コンパクト表示
- **タブレット**: 2カラム、中間表示
- **デスクトップ**: フル機能表示

### 5. パフォーマンス最適化

#### 5.1 データ取得最適化
- **初回ロード**: 20件のランキングデータのみ取得
- **ページネーション**: 必要時のみ追加データ取得
- **キャッシング**: React Queryを使用してデータキャッシュ
- **フィルタリング**: デバウンス機能で API呼び出し頻度制限

#### 5.2 レンダリング最適化
- **仮想化**: 大量データ表示時の仮想スクロール
- **メモ化**: React.memo, useMemo, useCallbackの活用
- **遅延ローディング**: 画像や重いコンポーネントの遅延読み込み

### 6. エラーハンドリング

#### 6.1 エラー種別と対応
```typescript
interface ErrorType {
  NETWORK_ERROR: '接続エラーが発生しました';
  UNAUTHORIZED: 'ログインが必要です';
  FORBIDDEN: 'アクセス権限がありません';
  NOT_FOUND: 'データが見つかりません';
  SERVER_ERROR: 'サーバーエラーが発生しました';
  UNKNOWN: '予期しないエラーが発生しました';
}
```

#### 6.2 エラー表示UI
```
┌─────────────────────────────────────┐
│ ⚠️  エラーが発生しました            │
│                                     │
│ 接続エラーが発生しました。          │
│ インターネット接続を確認して、      │
│ 再度お試しください。                │
│                                     │
│     [再試行]    [閉じる]           │
└─────────────────────────────────────┘
```

### 7. アクセシビリティ対応

#### 7.1 キーボードナビゲーション
- Tab/Shift+Tab: フォーカス移動
- Enter/Space: ボタン・リンク実行
- Escape: モーダル閉じる
- 矢印キー: リスト内移動

#### 7.2 スクリーンリーダー対応
- aria-label: 適切なラベル付け
- role: セマンティックなロール定義
- aria-live: 動的コンテンツの通知
- alt: 画像の代替テキスト

#### 7.3 視覚的配慮
- 高コントラスト対応
- フォントサイズ調整対応
- カラーバリアフリー対応

## 実装手順

### Phase 1: 基本コンポーネント作成
1. **RankingModal基本構造**: モーダル表示・閉じる機能
2. **RankingList基本表示**: 静的データでの一覧表示
3. **HamburgerMenu修正**: ランキング項目追加
4. **基本スタイリング**: TailwindCSSでの基本デザイン

### Phase 2: API統合とデータ管理
1. **API呼び出し関数作成**: ranking-api.ts実装
2. **useRankingフック作成**: 状態管理とAPI統合
3. **動的データ表示**: 実際のAPIデータでの表示
4. **ローディング・エラー状態**: 適切なフィードバック表示

### Phase 3: フィルタリング・ページネーション
1. **フィルタリング機能**: 難易度・期間別フィルタ
2. **ページネーション機能**: ページ切り替え機能
3. **URL状態管理**: フィルタ・ページ状態の永続化
4. **検索機能**: ユーザー名検索（将来拡張用）

### Phase 4: 個人記録表示
1. **UserRankingSection**: 個人統計表示
2. **個人スコア履歴**: ユーザーのスコア履歴表示
3. **タブ切り替え**: 全体・個人記録の切り替え
4. **パフォーマンス統計**: 詳細な個人パフォーマンス表示

### Phase 5: UX改善・最適化
1. **レスポンシブデザイン**: モバイル・タブレット対応
2. **アニメーション**: Framer Motionでの滑らかな遷移
3. **パフォーマンス最適化**: 仮想化・メモ化実装
4. **アクセシビリティ**: キーボード・スクリーンリーダー対応

### Phase 6: テスト・品質向上
1. **ユニットテスト**: コンポーネント・フック単体テスト
2. **統合テスト**: API統合テスト
3. **E2Eテスト**: ユーザーフロー全体テスト
4. **パフォーマンステスト**: レンダリング・API性能テスト

## 技術的考慮事項

### セキュリティ
- **XSS対策**: ユーザー名・スコア表示時のサニタイゼーション
- **認証確認**: API呼び出し時の認証状態確認
- **データ検証**: クライアントサイドでのデータ形式検証

### パフォーマンス
- **初回ロード最適化**: 必要最小限のデータ取得
- **メモリ管理**: 大量データ表示時のメモリリーク防止
- **ネットワーク最適化**: 重複API呼び出し防止
- **バンドルサイズ**: Tree shakingによるサイズ最適化

### 保守性
- **コンポーネント分離**: 単一責任原則に基づく設計
- **型安全性**: TypeScriptによる厳密な型定義
- **再利用性**: 共通コンポーネントの抽出
- **テスタビリティ**: テストしやすい構造設計

### 拡張性
- **国際化対応**: 多言語対応の準備
- **テーマ対応**: ダークモード・カスタムテーマ対応
- **分析機能**: 将来的な詳細分析機能の基盤準備
- **ソーシャル機能**: フレンド機能等の将来拡張対応

## テスト項目

### 機能テスト
- [ ] ランキングモーダルの開閉
- [ ] ランキングデータの正常表示
- [ ] フィルタリング機能の動作確認
- [ ] ページネーション機能の動作確認
- [ ] 個人記録表示の正確性
- [ ] レスポンシブデザインの動作確認

### API統合テスト
- [ ] ランキングAPI呼び出しの成功・失敗ケース
- [ ] 個人スコア履歴API呼び出しのテスト
- [ ] 認証状態に応じたAPI呼び出し制御
- [ ] エラーハンドリングの適切性
- [ ] ローディング状態の表示確認

### パフォーマンステスト
- [ ] 初回ロード時間の測定
- [ ] 大量データ表示時のパフォーマンス
- [ ] メモリ使用量の監視
- [ ] API呼び出し頻度の最適化確認

### アクセシビリティテスト
- [ ] キーボードナビゲーションの動作確認
- [ ] スクリーンリーダーでの読み上げ確認
- [ ] 高コントラストモードでの表示確認
- [ ] フォントサイズ変更時の表示確認

### ブラウザ・デバイステスト
- [ ] Chrome/Firefox/Safari/Edgeでの動作確認
- [ ] スマートフォン（iOS/Android）での動作確認
- [ ] タブレット（iPad/Android）での動作確認
- [ ] 異なる画面サイズでの表示確認

## 想定作業時間

### Phase 1: 基本コンポーネント作成
- **RankingModal, RankingList作成**: 2-3時間
- **HamburgerMenu修正**: 1時間
- **基本スタイリング**: 2時間
- **小計**: 5-6時間

### Phase 2: API統合とデータ管理
- **API関数・フック作成**: 2-3時間
- **動的データ表示**: 1-2時間
- **エラーハンドリング**: 1-2時間
- **小計**: 4-7時間

### Phase 3: フィルタリング・ページネーション
- **フィルタリング機能**: 2-3時間
- **ページネーション機能**: 2-3時間
- **URL状態管理**: 1-2時間
- **小計**: 5-8時間

### Phase 4: 個人記録表示
- **個人統計・履歴表示**: 3-4時間
- **タブ切り替え機能**: 1-2時間
- **小計**: 4-6時間

### Phase 5: UX改善・最適化
- **レスポンシブデザイン**: 3-4時間
- **アニメーション**: 2-3時間
- **パフォーマンス最適化**: 2-3時間
- **アクセシビリティ**: 2-3時間
- **小計**: 9-13時間

### Phase 6: テスト・品質向上
- **各種テスト実装**: 4-6時間
- **デバッグ・調整**: 2-4時間
- **小計**: 6-10時間

**総計**: 約33-50時間（設計・実装・テスト・調整含む）

## 次のステップ

1. **Phase 1から順次実装開始**
2. **各Phase完了後の動作確認とフィードバック**
3. **必要に応じた設計調整**
4. **段階的なユーザーテストの実施**
5. **最終的な品質確認とリリース準備**

## 補足事項

### 将来拡張予定機能
- **フレンド機能**: 友達同士でのランキング比較
- **グループランキング**: チーム・コミュニティ単位でのランキング
- **実績システム**: 各種達成項目とバッジ機能
- **詳細分析**: プレイ傾向の詳細分析とレポート
- **ソーシャル機能**: スコア共有・挑戦機能

### 技術債務管理
- **定期的なリファクタリング**: コードの保守性向上
- **依存関係の最新化**: セキュリティ・パフォーマンス向上
- **テストカバレッジの向上**: 品質保証の強化
- **ドキュメント更新**: 実装に応じたドキュメント更新

この設計書に基づいて、段階的にランキング画面機能を実装していきます。各Phase完了時にレビューを行い、必要に応じて設計を調整します。